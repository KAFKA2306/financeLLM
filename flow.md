# LLMシステムのデータ処理フローとストレージ設計

## 概要

このドキュメントでは、LLM評価システムにおけるデータの流れと永続化の戦略について説明します。システムは効率的な処理と再利用可能性を重視し、複数の中間データを保存・活用します。

## ディレクトリ構造

システムは以下のような階層的なディレクトリ構造を使用します：

```
base_dir/
├── data/              # 入力データの格納
│   ├── documents/     # 評価対象の文書
│   └── query.csv      # 評価用クエリ
├── output/
│   ├── logs/          # ログファイル
│   ├── raw_data/      # 前処理前の生データ
│   ├── processed/     # 処理済みデータ
│   ├── results/       # 評価結果
│   ├── analysis/      # 分析レポート
│   ├── vector_store/  # FAISSインデックス
│   ├── embeddings/    # 計算済みエンベディング
│   ├── chunks/        # 分割済み文書チャンク
│   └── progress/      # 処理進捗情報
```

## データ処理フロー

### 1. 文書の読み込みと前処理
- PDFファイルを読み込み、テキストを抽出
- 抽出したテキストは `raw_data/` に保存
- テキストを適切なサイズのチャンクに分割
- 分割されたチャンクは `chunks/` に JSON 形式で保存

### 2. ベクトルストアの構築
- 文書チャンクからベクトル表現を計算
- 計算されたエンベディングは `embeddings/` にキャッシュ
- FAISSインデックスを構築し、`vector_store/` に保存
- 既存のインデックスがある場合は再利用

### 3. クエリ処理
- クエリごとに以下の処理を実行：
  1. クエリのベクトル表現を計算（キャッシュがあれば再利用）
  2. 関連文書の検索
  3. LLMによる回答生成
  4. 結果の評価
- 処理状態を `progress/` に記録
- 各ステップの結果を適切なディレクトリに保存

### 4. 結果の保存
- 個別の評価結果：`results/` に JSON 形式で保存
- モデルごとの集計結果：`processed/` に CSV 形式で保存
- 分析レポート：`analysis/` に JSON 形式で保存

## キャッシュ戦略

### エンベディングのキャッシュ
```python
text_hash = hashlib.md5(text.encode()).hexdigest()
embedding_file = embedding_dir / f"{text_hash}.npy"
```
- テキストのハッシュ値をキーとして使用
- NumPy配列として保存
- 頻繁に使用されるクエリの処理を高速化

### ベクトルストアのキャッシュ
```python
vector_store_path = output_dir / "vector_store"
if vector_store_path.exists():
    return FAISS.load_local(str(vector_store_path), embeddings)
```
- FAISSインデックスをファイルシステムに保存
- 同じ文書セットに対する複数回の評価を効率化

### 進捗管理
```json
{
    "processed_queries": ["model1_query1", "model1_query2", ...],
    "last_update": "2024-01-25T10:30:00"
}
```
- 処理済みクエリのIDを記録
- 中断時の再開を可能に
- 部分的な再実行をサポート

## データ保持ポリシー

### キャッシュの有効期限
- ベクトルストア：文書セットが更新されるまで保持
- エンベディング：30日間保持
- 中間結果：7日間保持

### クリーンアップ戦略
- 古いキャッシュファイルの定期的な削除
- ディスク使用量の監視
- 重要な結果のバックアップ

## エラー処理とリカバリ

### エラー時のデータ保存
- エラーが発生した時点での中間結果を保存
- エラーログとスタックトレースの記録
- 処理状態のスナップショットを作成

### リカバリ手順
1. 最後の正常な状態を確認
2. 必要なキャッシュの有効性を検証
3. 未完了のクエリを特定
4. 処理を再開

## 改善の提案

### 短期的な改善点
1. キャッシュヒット率の計測機能の追加
2. 処理の進捗状況の可視化
3. キャッシュサイズの最適化

### 長期的な改善点
1. 分散ストレージへの対応
2. キャッシュの圧縮機能の実装
3. インクリメンタルなインデックス更新の実装

このデータフローと保存戦略により、システムは以下の利点を得ることができます：

1. 処理時間の大幅な短縮
2. リソース使用の最適化
3. システムの耐障害性の向上
4. デバッグと分析の容易さ